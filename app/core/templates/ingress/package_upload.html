{% extends "base.html" %}
{% load i18n %}
{% load spf_extras %}

{% block title %}
SciELO Publishing Framework - {% trans 'Upload package' %}
{% endblock %}

{% block content %}
<h1 class="h4 pt-5">{% trans 'Upload package' %}</h1>

<div class="row my-3">
    <div class="col-auto mb-3">
        <div class="card my-3">
            <div class="card-header">
                {% trans 'Upload a package for updating site content' %}
            </div>
            <div class="card-body">
                <form class="bg-white form-user" action="" method="post" id="upload_form">
                    {% csrf_token %}
                    <div class="form-group mb-3">
                        <label class="form-label" for="id_package_file">{% trans 'Package File' %}</label>
                        <input type="file" name="package_file" class="form-control" required id="id_package_file">
                        <div class="form-text">{% trans 'Hint: choose a ZIP file.' %}</div>
                    </div>
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button id="buttonReset" type="reset" class="btn btn-outline-danger">{% trans 'Reset' %}</button>
                        <input id='btn_upload_file' type="submit" value="{% trans 'Upload' %}" class="btn btn-primary"/>
                    </div>
                </form>
                <div class="mt-3 container bg-white progress" id="progress"></div>
            </div>
        </div>
    </div>

    <div id="div_uploaded_packages" style="display: none;">
        <div class="table-responsive">
            <table class="table table-sm table-bordered table-striped">
                <thead>
                    <tr>
                        <th>{% trans 'Uploaded package' %}</th>
                        <th>{% trans 'SciELO ISSN' %}</th>
                        <th>{% trans 'Journal acronym' %}</th>
                        <th>{% trans 'Document' %}</th>
                        <th>{% trans 'Package generated' %}</th>
                        <th>{% trans 'Version' %}</th>
                        <th>{% trans 'Uploaded datetime' %}</th>
                    </tr>
                </thead>
                <tbody id="tbody_uploaded_packages"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
const form_upload = document.getElementById('upload_form');
const input_file = document.getElementById('id_package_file');
const progress_bar = document.getElementById('progress');
const btn_upload_file = document.getElementById('btn_upload_file');

$("#upload_form").submit(function(e){
    e.preventDefault();
    $form = $(this)
    var form_data = new FormData(this);
    const media_data = input_file.files[0];

    btn_upload_file.disabled = true;

    $.ajax({
        type: 'POST',
        url:'/ingress/package_upload/',
        data: form_data,
        dataType: 'json',
        beforeSend: function(){},
        xhr:function(){
            const xhr = new window.XMLHttpRequest();
            xhr.upload.addEventListener('progress', e=>{
                if(e.lengthComputable){
                    const percentProgress = (e.loaded/e.total)*100;
                    progress_bar.innerHTML = `<div class="progress-bar progress-bar-striped bg-success" role="progressbar" style="width: ${percentProgress}%" aria-valuenow="${percentProgress}" aria-valuemin="0" aria-valuemax="100"></div>`
                }
            });
            return xhr
        },
        success: function(response){
            form_upload.reset();
            progress_bar.innerHTML = '';

            if ('article_files' in response){
                if (response['article_files'][0] == 'error'){
                    baseMessages = document.getElementById('baseMessages');
                    cleanMessages(baseMessages);
                    error_message = gettext('It was not possible to upload package. Please, provide a valid ZIP file.');
                    baseMessages.appendChild(createMessage(error_message, 'alert-danger'))
                } else {
                    journal_uri = response['opac_uri'] + '/j/';
                    ingressPackageUploadPopulateTable(response, journal_uri);
                }
            }

            btn_upload_file.disabled = false;
        },
        error: function(err){
            console.log(err);
        },
        cache: false,
        contentType: false,
        processData: false,
    });
});
</script>
{% endblock %}